<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹: Ø¯ÛŒØ³ÛŒÙ¾Ù„ÛŒÙ† + Ù…Ø§Ù„ÛŒ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #0f172a;
    --card-bg: #1e293b;
    --card-border: #334155;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --radius: 16px;
    
    /* Colors */
    --c-growth: #8b5cf6;
    --c-health: #10b981;
    --c-wealth: #f59e0b;
    --c-mind:   #3b82f6;
    --c-social: #f43f5e;
    --c-admin:  #64748b;
    
    --c-pos: #10b981; /* Positive/Income - Green */
    --c-neg: #ef4444; /* Negative/Expense - Red */
  }

  body {
    font-family: system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text-main);
    margin: 0;
    padding: 24px;
    line-height: 1.6;
  }

  /* --- Layout & Tabs --- */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .nav-tabs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 10px;
  }

  .nav-btn {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    color: var(--text-muted);
    padding: 10px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    transition: all 0.2s;
  }
  .nav-btn.active {
    background: var(--c-growth);
    color: white;
    border-color: var(--c-growth);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .tab-content { display: none; }
  .tab-content.active { display: flex; flex-direction: column; gap: 20px; }

  h1 {
    margin: 0; font-size: 22px; font-weight: 800;
    background: linear-gradient(to right, #fff, #94a3b8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }

  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  /* --- Common Inputs/Buttons --- */
  input, select {
    background: #020617;
    border: 1px solid var(--card-border);
    color: var(--text-main);
    padding: 8px 12px;
    border-radius: 8px;
    outline: none; transition: 0.2s;
  }
  input:focus, select:focus { border-color: var(--c-growth); }
  input[type=number].small { width: 60px; text-align: center; }

  .btn {
    border: none; padding: 8px 16px; border-radius: 8px;
    color: #fff; font-weight: 600; cursor: pointer; font-size: 13px;
    display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;
  }
  .btn:hover { transform: translateY(-1px); }
  .btn.primary { background: linear-gradient(135deg, var(--c-growth), var(--c-mind)); }
  .btn.success { background: linear-gradient(135deg, var(--c-health), #059669); }
  .btn.ghost { background: transparent; border: 1px solid var(--card-border); color: var(--text-muted); }
  .btn.ghost:hover { border-color: var(--text-main); color: var(--text-main); }
  .btn.danger { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
  .btn.danger:hover { background: rgba(239, 68, 68, 0.25); }
  .btn.mini { padding: 4px 8px; font-size: 12px; border-radius: 6px; line-height: 1; }
  .btn.mini.full { padding: 0; width: 100%; height: 100%; font-size: 14px; border-radius: 4px; line-height: 1; }
  
  /* --- Discipline Specific --- */
  .controls-bar { display: flex; gap: 15px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
  .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
  @media (min-width: 1024px) { .charts-grid { grid-template-columns: 1fr 2fr; } }
  .chart-wrapper { position: relative; height: 350px; width: 100%; }
  .zoom-toggle {
    position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.4);
    padding: 4px 8px; border-radius: 6px; font-size: 11px; display: flex; align-items: center; gap: 6px; z-index: 10;
  }
  .checklist-container { overflow-x: auto; padding-bottom: 8px; }
  .row { display: grid; gap: 2px; margin-bottom: 4px; align-items: stretch; }
  .cell { display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 13px; position: relative; }
  .cell.task {
    justify-content: center; padding: 0 8px; font-weight: 600; color: #fff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .cell.header-cell { background: var(--card-bg); border: 1px solid var(--card-border); color: var(--text-muted); font-weight: bold; height: 36px; }
  .cell.day { background: rgba(30, 41, 59, 0.5); padding: 3px; }
  input[type=checkbox] {
    appearance: none; width: 100%; height: 100%; margin: 0; background: transparent;
    border: 1px solid #334155; border-radius: 4px; cursor: pointer; display: grid; place-content: center;
  }
  input[type=checkbox]:checked { border-color: transparent; box-shadow: 0 0 8px rgba(255, 255, 255, 0.2); }
  input[type=checkbox]:checked::before { content: "âœ”"; color: white; font-size: 14px; font-weight: 900; }
  .footer { display: grid; gap: 20px; font-size: 14px; }
  .footer-section { border-bottom: 1px solid var(--card-border); padding-bottom: 15px; }
  .footer-section:last-child { border-bottom: none; padding-bottom: 0; }
  .section-title { font-weight: 700; color: var(--text-main); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .action-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .tag-display { display: flex; gap: 5px; flex-wrap: wrap; background: #020617; padding: 5px; border-radius: 6px; flex-grow: 1; min-height: 38px; }
  .tag { padding: 2px 10px; border-radius: 12px; font-size: 11px; color: white; display: flex; align-items: center; gap: 5px; }
  .tag .del { cursor: pointer; font-weight: bold; opacity: 0.7; margin-right: 4px; }
  .tag .del:hover { opacity: 1; color: #fca5a5; }

  /* --- Finance Specific --- */
  .accounts-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;
  }
  .acc-card {
    background: #0f172a; border: 1px solid var(--card-border); border-radius: 12px; padding: 15px;
    display: flex; flex-direction: column; gap: 10px; position: relative;
  }
  .acc-card.main { border-color: var(--c-mind); }
  .acc-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    font-size: 14px; 
    color: var(--text-muted); 
    font-weight: 600;
    margin-bottom: 5px;
  }
  .acc-header span:first-child { color: var(--text-main); font-size: 16px; }
  .acc-balance { font-size: 22px; font-weight: 800; color: var(--text-main); }
  
  .finance-controls {
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
  }
  @media (max-width: 800px) { .finance-controls { grid-template-columns: 1fr; } }

  .history-list {
    max-height: 400px; 
    overflow-y: auto;
    border: 1px solid var(--card-border); 
    border-radius: 12px;
    background: #020617;
  }
  .history-item {
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    padding: 12px 15px; 
    border-bottom: 1px solid var(--card-border); 
    font-size: 13px;
    transition: background-color 0.2s;
  }
  .history-item:hover { background: #121d2e; }
  .history-item:last-child { border-bottom: none; }
  
  /* History Colors */
  .amt.pos { color: var(--c-pos); }
  .amt.neg { color: var(--c-neg); }
  .amt.transfer { color: var(--c-mind); font-weight: 700; }
  .trans-detail { text-align: left; }
  .trans-type { display: block; font-size: 10px; color: var(--text-muted); margin-top: 4px;}

</style>
</head>
<body>

<div class="container">

  <div class="nav-tabs">
    <button class="nav-btn active" onclick="switchTab('discipline', this)">ğŸ¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯ÛŒØ³ÛŒÙ¾Ù„ÛŒÙ†</button>
    <button class="nav-btn" onclick="switchTab('finance', this)">ğŸ’° Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ</button>
  </div>

  <div id="tab-discipline" class="tab-content active">
    
    <div class="card controls-bar">
      <div style="display:flex; gap:10px; align-items:center;">
          <h1>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¹Ø§Ø¯Øªâ€ŒÙ‡Ø§</h1>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
          <label>Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡:</label>
          <input class="small" type="number" id="daysInput" value="30" min="7" max="365" />
          <button class="btn primary" id="reloadBtn">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
          <button class="btn ghost" id="saveBtn">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card" style="position:relative;">
        <div class="section-title">ğŸ¯ ØªØ¹Ø§Ø¯Ù„ Ú†Ø±Ø® Ø²Ù†Ø¯Ú¯ÛŒ</div>
        <div class="zoom-toggle">
          <input type="checkbox" id="zoomToggle" checked style="width:14px; height:14px;">
          <label for="zoomToggle" style="color:#fff; cursor:pointer;">Ø²ÙˆÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯</label>
        </div>
        <div class="chart-wrapper"><canvas id="radarChart"></canvas></div>
      </div>
      <div class="card">
        <div class="section-title">ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ø±ÙˆØ²Ø§Ù†Ù‡</div>
        <div class="chart-wrapper"><canvas id="lineChart"></canvas></div>
      </div>
    </div>

    <div class="card checklist-container">
      <div id="checklist"></div>
    </div>

    <div class="card footer">
      <div class="footer-section">
          <span class="section-title">âš¡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</span>
          <div class="action-row">
              <input type="text" id="newTaskName" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¹Ø§Ø¯Øª..." style="flex-grow:1" />
              <select id="newTaskCategory" style="min-width:140px"></select>
              <input type="number" id="newTaskFreq" class="small" step="0.1" min="0.1" max="1" value="1" placeholder="Ø¶Ø±ÛŒØ¨" />
              <button class="btn primary" id="addTaskBtn">Ø§ÙØ²ÙˆØ¯Ù†</button>
          </div>
      </div>
      <div class="footer-section">
          <span class="section-title">ğŸ·ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</span>
          <div class="action-row">
              <select id="multiTaskSelect" style="min-width:200px"><option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±...</option></select>
              <div id="taskTagBox" class="tag-display"></div>
              <select id="addTagSelect" style="width:130px"><option value="">+ ØªÚ¯...</option></select>
              <button class="btn ghost" id="applyTagsBtn">Ø§ÙØ²ÙˆØ¯Ù† ØªÚ¯</button>
          </div>
          <div class="action-row" style="margin-top:12px; justify-content: space-between;">
              <div style="display:flex; gap:8px; align-items:center;">
                  <label>ØªØºÛŒÛŒØ± Ø¶Ø±ÛŒØ¨:</label>
                  <input type="number" id="freqInput" class="small" step="0.1" min="0" max="1" />
                  <button class="btn ghost" id="setFreqBtn">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                  <button class="btn ghost" id="addCatBtn">Ú©ØªÚ¯ÙˆØ±ÛŒ Ø¬Ø¯ÛŒØ¯</button>
                  <input type="text" id="newCatName" placeholder="Ù†Ø§Ù…..." style="width:100px" />
                  <select id="deleteTaskSelect" style="min-width:150px"></select>
                  <button class="btn danger" id="deleteTaskBtn">Ø­Ø°Ù Ú©Ø§Ø±</button>
                  <select id="delCatSelect" style="display:none"></select>
              </div>
          </div>
      </div>
    </div>
  </div>

  <div id="tab-finance" class="tab-content">
    
    <div class="card" style="padding: 15px; border-color: var(--c-growth); text-align: center;">
        <div class="section-title" style="margin-bottom: 5px; justify-content: center;">ğŸ’¶ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ø¯Ø§Ø±Ø§ÛŒÛŒ</div>
        <div id="totalBalanceDisplay" style="font-size: 30px; font-weight: 900; color: var(--c-wealth);">0 ØªÙˆÙ…Ø§Ù†</div>
    </div>

    <div class="accounts-grid" id="accountsContainer">
        </div>

    <div class="finance-controls">
        <div class="card">
            <div class="section-title">ğŸ’¸ Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ (Ø®Ø±Ø¬/Ø¯Ø±Ø¢Ù…Ø¯)</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <input type="text" id="transDesc" placeholder="Ø¨Ø§Ø¨Øª Ú†ÛŒØŸ (Ù…Ø«Ù„Ø§: Ø®Ø±ÛŒØ¯ Ø³ÙˆÙ¾Ø±Ù…Ø§Ø±Ú©Øª)">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="transAmount" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" style="flex-grow:1">
                    <select id="transAcc" style="width:140px"></select>
                </div>
                <button class="btn danger" onclick="addTransaction('expense')">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ (-)</button>
                <button class="btn" onclick="addTransaction('income')" style="background-color:var(--c-pos)">Ø«Ø¨Øª Ø¯Ø±Ø¢Ù…Ø¯ (+)</button>
            </div>
        </div>
        
        <div class="card">
            <div class="section-title">ğŸ” Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÛŒÙ† Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="transferFromAcc" style="flex-grow:1"></select>
                    <span style="white-space:nowrap; color:var(--text-muted);">Ø¨Ù‡</span>
                    <select id="transferToAcc" style="flex-grow:1"></select>
                </div>
                <input type="text" id="transferAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù†ØªÙ‚Ø§Ù„ (ØªÙˆÙ…Ø§Ù†)">
                <button class="btn" onclick="addTransfer()" style="background: var(--c-mind);">Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ¬Ù‡</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">ğŸ“ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</div>
        <div class="history-list" id="historyList"></div>
        <button class="btn ghost" style="margin-top:10px;" onclick="clearHistory()">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
    </div>

    <div class="card">
        <div class="section-title">ğŸ› ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ Ù…Ø§Ù‡ (Ø¯Ø±Ø¢Ù…Ø¯ Ø«Ø§Ø¨Øª)</div>
        <div class="action-row" style="background:#020617; padding:15px; border-radius:12px; border:1px solid #334155;">
            <div>
                <label style="display:block; margin-bottom:5px;">Ø¯Ø±Ø¢Ù…Ø¯ ÙˆØ±ÙˆØ¯ÛŒ (ØªÙˆÙ…Ø§Ù†)</label>
                <input type="text" id="finIncome" value="35,000,000" style="width:150px; font-weight:bold; color:#10b981;">
            </div>
            <div>
                <label style="display:block; margin-bottom:5px;">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù‚Ø³Ø§Ø· Ø«Ø§Ø¨Øª</label>
                <input type="text" id="finFixed" value="0" placeholder="Ù…Ø«Ù„Ø§ 5,000,000" style="width:150px; color:#ef4444;">
            </div>
            <div style="flex-grow:1; text-align:left; display:flex; align-items:end; justify-content:end;">
                 <button class="btn success" onclick="resetFinanceMonth()">ğŸ“… Ø´Ø±ÙˆØ¹ Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ùˆ ØªÙ‚Ø³ÛŒÙ… Ø¨ÙˆØ¯Ø¬Ù‡</button>
            </div>
        </div>
        <div style="margin-top:10px; font-size:12px; color:var(--text-muted);">
            * Ø¨Ø§ Ø²Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ù„Ø§: Ø¯Ø±Ø¢Ù…Ø¯ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ **Ù…Ù‡Ø±Ø¨Ø§Ù†ÛŒ** Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø§Ù‚Ø³Ø§Ø· Ú©Ù… Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ØŒ Û².ÛµÙ… Ø¨Ù‡ **ØµØ§Ø¯Ø±Ø§Øª** Ùˆ Û³Ù… Ø¨Ù‡ **Ø¨Ù„Ùˆ** ÙˆØ§Ø±ÛŒØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯. **Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ Ø¬Ø§Ø±ÛŒ Ø¯Ø³Øª Ù†Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯.**
        </div>
    </div>

  </div>

</div>

<script>
/* =========================================
   GLOBAL & TABS
   ========================================= */
const STORAGE_KEY = 'Dashboard_V11_Final_Fix';

function switchTab(tab, el) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(`tab-${tab}`).classList.add('active');
    el.classList.add('active');
}

// Formatting utility for Money (35,000,000)
function fmt(num) { return Number(num).toLocaleString('en-US'); }
function unFmt(str) { return parseInt(String(str).replace(/,/g, '')) || 0; }

// Auto-format inputs
['finIncome', 'finFixed', 'transAmount', 'transferAmount'].forEach(id => {
    document.getElementById(id).addEventListener('input', function(e) {
        let val = unFmt(this.value);
        if(!isNaN(val)) this.value = fmt(val);
    });
});

/* =========================================
   PART 1: DISCIPLINE LOGIC (Full Restore)
   ========================================= */
const CAT_CONFIG = {
    'Ø±Ø´Ø¯ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ': '#8b5cf6', 'Ø³Ù„Ø§Ù…Øª Ø¬Ø³Ù…Ø§Ù†ÛŒ': '#10b981',
    'Ú©Ø§Ø± Ùˆ Ø«Ø±ÙˆØª': '#f59e0b', 'Ø°Ù‡Ù† Ùˆ Ø±ÙˆØ§Ù†': '#3b82f6',
    'Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª': '#f43f5e', 'Ù†Ø¸Ù… Ø´Ø®ØµÛŒ': '#64748b'
};

function getCatColor(cat) {
    if(CAT_CONFIG[cat]) return CAT_CONFIG[cat];
    let hash = 0; for (let i=0; i<cat.length; i++) hash = cat.charCodeAt(i)+((hash<<5)-hash);
    return `hsl(${Math.abs(hash)%360}, 65%, 55%)`;
}
function uid(){ return Math.random().toString(36).substr(2, 9); }

let tasks = [
    { id: uid(), name: 'ØªÙ…Ø±Ú©Ø² Ùˆ Ù…Ø¯ÛŒØªÛŒØ´Ù†', categories: ['Ø°Ù‡Ù† Ùˆ Ø±ÙˆØ§Ù†'], freq: 1 },
    { id: uid(), name: 'ÙˆØ±Ø²Ø´ Ø³Ù†Ú¯ÛŒÙ†/Ù‡ÙˆØ§Ø²ÛŒ', categories: ['Ø³Ù„Ø§Ù…Øª Ø¬Ø³Ù…Ø§Ù†ÛŒ'], freq: 0.8 },
    { id: uid(), name: 'Ø®ÙˆØ§Ø¨ Ø¨Ø§ Ú©ÛŒÙÛŒØª', categories: ['Ø³Ù„Ø§Ù…Øª Ø¬Ø³Ù…Ø§Ù†ÛŒ'], freq: 1 },
    { id: uid(), name: 'Ù¾Ø±ÙˆÚ˜Ù‡ DigiProof', categories: ['Ú©Ø§Ø± Ùˆ Ø«Ø±ÙˆØª', 'Ø±Ø´Ø¯ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ'], freq: 0.7 },
    { id: uid(), name: 'Ù…Ø·Ø§Ù„Ø¹Ù‡ ØªØ®ØµØµÛŒ', categories: ['Ø±Ø´Ø¯ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ'], freq: 0.8 },
    { id: uid(), name: 'Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ', categories: ['Ú©Ø§Ø± Ùˆ Ø«Ø±ÙˆØª'], freq: 0.5 },
    { id: uid(), name: 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±ÙˆØ²Ø§Ù†Ù‡', categories: ['Ø°Ù‡Ù† Ùˆ Ø±ÙˆØ§Ù†'], freq: 0.9 },
    { id: uid(), name: 'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ù‡Ø§Ø±Øª', categories: ['Ø±Ø´Ø¯ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ'], freq: 0.6 },
    { id: uid(), name: 'Ø§Ø±ØªØ¨Ø§Ø· Ù…Ø¤Ø«Ø±', categories: ['Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª'], freq: 0.5 },
    { id: uid(), name: 'Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ ÙØ±Ø¯Ø§', categories: ['Ù†Ø¸Ù… Ø´Ø®ØµÛŒ'], freq: 1 },
    { id: uid(), name: 'Ù†ÙˆØ´ÛŒØ¯Ù† Ø¢Ø¨ Ú©Ø§ÙÛŒ', categories: ['Ø³Ù„Ø§Ù…Øª Ø¬Ø³Ù…Ø§Ù†ÛŒ'], freq: 0.6 },
    { id: uid(), name: 'Ù…Ø±ÙˆØ± Ù‡ÙØªÚ¯ÛŒ', categories: ['Ù†Ø¸Ù… Ø´Ø®ØµÛŒ'], freq: 0.4 }
];
let categories = Object.keys(CAT_CONFIG);
let daysCount = 30;

/* Finance State */
let finance = {
    accounts: [
        { id: 1, name: 'Ù…Ù‡Ø±Ø¨Ø§Ù†ÛŒ', balance: 0 },
        { id: 2, name: 'ØµØ§Ø¯Ø±Ø§Øª', balance: 0 },
        { id: 3, name: 'Ø¨Ù„Ùˆ', balance: 0 },
        { id: 4, name: 'Ø¬Ø§Ø±ÛŒ', balance: 0 }
    ],
    history: []
};

/* Storage */
function getCurrentChecks() {
    const s = {};
    document.querySelectorAll('input[type=checkbox][data-task-id]').forEach(ch => s[ch.id] = ch.checked);
    return s;
}
function saveState() {
    const data = { daysCount, tasks, categories, checkboxState: getCurrentChecks(), finance };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadState() {
    const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if(s.daysCount) daysCount = s.daysCount;
    if(s.tasks) tasks = s.tasks;
    if(s.categories) categories = s.categories;
    if(!categories.length) categories = Object.keys(CAT_CONFIG);
    
    // Load finance and ensure names are correct
    if(s.finance) {
        finance = s.finance;
        // Ensure names are correct regardless of old data structure
        if (finance.accounts.length === 4) {
            finance.accounts[0].name = 'Ù…Ù‡Ø±Ø¨Ø§Ù†ÛŒ';
            finance.accounts[1].name = 'ØµØ§Ø¯Ø±Ø§Øª';
            finance.accounts[2].name = 'Ø¨Ù„Ùˆ';
            finance.accounts[3].name = 'Ø¬Ø§Ø±ÛŒ';
        }
    }


    document.getElementById('daysInput').value = daysCount;
    buildChecklist(s.checkboxState || {});
    updateCharts();
    renderFinance();
}

/* Charts */
Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = '#334155';
const radarCtx = document.getElementById('radarChart').getContext('2d');
const radarChart = new Chart(radarCtx, {
    type: 'radar',
    data: { datasets: [{ backgroundColor: 'rgba(255,255,255,0.05)', borderColor: 'rgba(255,255,255,0.4)', borderWidth: 1, pointRadius: 5 }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { r: { min:0, angleLines:{color:'#334155'}, grid:{color:'#334155'}, ticks:{display:false, count:6}, pointLabels:{font:{size:12, weight:'700'}, color:c=>c.label==='Ø¯ÛŒØ³ÛŒÙ¾Ù„ÛŒÙ†'?'#fff':getCatColor(c.label)} } } }
});
const lineCtx = document.getElementById('lineChart').getContext('2d');
const lineChart = new Chart(lineCtx, {
    type: 'line',
    data: { datasets: [{ borderColor: '#38bdf8', backgroundColor: 'rgba(56,189,248,0.1)', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 3 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true, grid:{color:'#1e293b'}}, x:{grid:{display:false}}} }
});

/* Logic */
function getGradient(cats) {
    const valid = cats.filter(c=>c!=='Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡');
    if(!valid.length) return '#334155';
    if(valid.length===1) return `linear-gradient(90deg, ${getCatColor(valid[0])}33, ${getCatColor(valid[0])}88)`;
    return `linear-gradient(90deg, ${valid.map(c=>getCatColor(c)+'66').join(', ')})`;
}

function buildChecklist(savedState = {}) {
    const list = document.getElementById('checklist'); list.innerHTML = '';
    const colStyle = `grid-template-columns: 200px repeat(${daysCount}, 40px)`;
    const header = document.createElement('div'); header.className = 'row'; header.style = colStyle;
    header.innerHTML = `<div class="cell header-cell">Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±</div>` + Array.from({length:daysCount},(_,i)=>`<div class="cell header-cell">${i+1}</div>`).join('');
    list.appendChild(header);

    tasks.forEach(task => {
        const row = document.createElement('div'); row.className = 'row'; row.style = colStyle;
        const nameCell = document.createElement('div'); nameCell.className = 'cell task'; nameCell.textContent = task.name; nameCell.style.background = getGradient(task.categories);
        row.appendChild(nameCell);
        for(let d=0; d<daysCount; d++) {
            const cell = document.createElement('div'); cell.className = 'cell day';
            const chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = `t-${task.id}-d${d}`; chk.dataset.taskId = task.id;
            if(savedState[chk.id]) chk.checked = true;
            chk.style.accentColor = getCatColor(task.categories[0]||'gray'); chk.onchange = ()=>{ saveState(); updateCharts(); };
            cell.appendChild(chk); row.appendChild(cell);
        }
        list.appendChild(row);
    });
    
    // Footer buttons
    const btnRow = document.createElement('div'); btnRow.className = 'row'; btnRow.style = colStyle;
    btnRow.innerHTML = `<div class="cell"><button class="btn danger mini full" onclick="if(confirm('Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ØŸ')){document.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); saveState(); updateCharts();}">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button></div>`;
    for(let d=0; d<daysCount; d++){
        btnRow.innerHTML += `<div class="cell day"><button class="btn ghost mini full" onclick="if(confirm('Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø³ØªÙˆÙ† ${d+1}ØŸ')){tasks.forEach(t=>{const el=document.getElementById('t-'+t.id+'-d'+${d});if(el)el.checked=false;});saveState();updateCharts();}">Ã—</button></div>`;
    }
    list.appendChild(btnRow);
    updateSelects();
}

function updateCharts() {
    const lineData = Array(daysCount).fill(0);
    const catStats = {}; categories.forEach(c=>catStats[c]={total:0,done:0});
    let discSum=0, discMax=0;
    tasks.forEach(t=>{
        const w = parseFloat(t.freq)||1; discMax+=(w*daysCount);
        for(let d=0; d<daysCount; d++){
            const el = document.getElementById(`t-${t.id}-d${d}`);
            if(el && el.checked){ lineData[d]++; discSum+=w; }
            t.categories.forEach(c=>{ if(!catStats[c])catStats[c]={total:0,done:0}; catStats[c].total++; if(el&&el.checked)catStats[c].done++; });
        }
    });
    const rLab=[], rDat=[], rCol=[];
    categories.forEach(c=>{ if(catStats[c]?.total>0){ rLab.push(c); rDat.push((catStats[c].done/catStats[c].total)*100); rCol.push(getCatColor(c)); } });
    rLab.push('Ø¯ÛŒØ³ÛŒÙ¾Ù„ÛŒÙ†'); rDat.push(discMax?(discSum/discMax)*100:0); rCol.push('#fff');

    const isZoom = document.getElementById('zoomToggle').checked;
    let rMax = 100;
    if(isZoom) { const m = Math.max(...rDat); rMax = Math.min(100, Math.ceil(m/10)*10); if(rMax<10)rMax=10; }

    lineChart.data.labels = Array.from({length:daysCount},(_,i)=>i+1); lineChart.data.datasets[0].data = lineData; lineChart.update();
    radarChart.data.labels = rLab; radarChart.data.datasets[0].data = rDat; radarChart.data.datasets[0].pointBackgroundColor = rCol;
    radarChart.options.scales.r.max = rMax; radarChart.options.scales.r.ticks.stepSize = rMax/5; radarChart.update();
}

function updateSelects() {
    const fill = (id, l) => { const el = document.getElementById(id); el.innerHTML=''; l.forEach(x=>el.add(new Option(x,x))); };
    fill('newTaskCategory', categories); fill('addTagSelect', categories); fill('delCatSelect', categories);
    const tEl = document.getElementById('multiTaskSelect'); tEl.innerHTML='<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±...</option>';
    tasks.forEach(t=>tEl.add(new Option(t.name, t.id)));
    const dEl = document.getElementById('deleteTaskSelect'); dEl.innerHTML='';
    tasks.forEach(t=>dEl.add(new Option(t.name, t.id)));
}

// Task Actions
document.getElementById('reloadBtn').onclick=()=>{ daysCount=parseInt(document.getElementById('daysInput').value)||30; const s=getCurrentChecks(); buildChecklist(s); saveState(); updateCharts(); };
document.getElementById('saveBtn').onclick=()=>{ saveState(); alert('Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯'); };
document.getElementById('zoomToggle').onchange=()=>updateCharts();
document.getElementById('addTaskBtn').onclick=()=>{
    const n=document.getElementById('newTaskName').value, c=document.getElementById('newTaskCategory').value;
    if(n){ tasks.push({id:uid(), name:n, categories:[c||'Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡'], freq:document.getElementById('newTaskFreq').value}); document.getElementById('newTaskName').value=''; saveAndRef(); }
};
document.getElementById('deleteTaskBtn').onclick=()=>{
    const id=document.getElementById('deleteTaskSelect').value;
    if(id && confirm('Ø­Ø°ÙØŸ')){ tasks=tasks.filter(t=>t.id!==id); saveAndRef(); }
};
document.getElementById('applyTagsBtn').onclick=()=>{
    const id=document.getElementById('multiTaskSelect').value, c=document.getElementById('addTagSelect').value;
    if(id){ const t=tasks.find(x=>x.id===id); if(!t.categories.includes(c)) t.categories.push(c); saveAndRef(); }
};
document.getElementById('setFreqBtn').onclick=()=>{
    const id=document.getElementById('multiTaskSelect').value; if(id){ tasks.find(x=>x.id===id).freq=document.getElementById('freqInput').value; saveAndRef(); alert('Ø¨Ø±ÙˆØ² Ø´Ø¯'); }
};
document.getElementById('addCatBtn').onclick=()=>{
    const n=document.getElementById('newCatName').value; if(n && !categories.includes(n)){ categories.push(n); document.getElementById('newCatName').value=''; saveAndRef(); }
};
document.getElementById('multiTaskSelect').onchange=function(){
    const t=tasks.find(x=>x.id===this.value); if(!t)return;
    document.getElementById('freqInput').value=t.freq;
    const b=document.getElementById('taskTagBox'); b.innerHTML='';
    t.categories.forEach(c=>{ b.innerHTML+=`<span class="tag" style="background:${getCatColor(c)}">${c}<span class="del" onclick="remTag('${t.id}','${c}')">âœ•</span></span>`; });
};
window.remTag=(id,c)=>{ const t=tasks.find(x=>x.id===id); t.categories=t.categories.filter(x=>x!==c); if(!t.categories.length)t.categories=['Ø¨Ø¯ÙˆÙ† Ø¯Ø³ØªÙ‡']; saveAndRef(); };
function saveAndRef(){ saveState(); const sel=document.getElementById('multiTaskSelect').value; buildChecklist(getCurrentChecks()); updateCharts(); if(sel)document.getElementById('multiTaskSelect').value=sel; }


/* =========================================
   PART 2: FINANCE LOGIC (FIXED)
   ========================================= */

function renderFinance() {
    // 1. Calculate and Display Total Balance
    let totalBalance = finance.accounts.reduce((sum, acc) => sum + acc.balance, 0);
    const totalDisplay = document.getElementById('totalBalanceDisplay');
    if (totalDisplay) {
        totalDisplay.textContent = `${fmt(totalBalance)} ØªÙˆÙ…Ø§Ù†`;
        totalDisplay.style.color = totalBalance >= 0 ? 'var(--c-wealth)' : 'var(--c-neg)';
    }

    // 2. Render Accounts
    const con = document.getElementById('accountsContainer');
    con.innerHTML = '';
    
    finance.accounts.forEach(acc => {
        const card = document.createElement('div');
        card.className = `acc-card ${acc.id === 4 ? 'main' : ''}`;
        
        // Custom button logic for Jari account (ID 4)
        let extraHeaderContent = `<span>#${acc.id}</span>`;
        if(acc.id === 4) {
            extraHeaderContent = `<button class="btn mini" onclick="chargeWeekly()" style="background:var(--c-mind);">âš¡ Ø´Ø§Ø±Ú˜ 2Ù…</button>`;
        }

        card.innerHTML = `
            <div class="acc-header">
                <span>${acc.name}</span> 
                ${extraHeaderContent}
            </div>
            <div class="acc-balance" style="color:${acc.balance < 0 ? 'var(--c-neg)' : 'var(--text-main)'}">${fmt(acc.balance)} <small style="font-size:12px;color:#94a3b8">ØªÙˆÙ…Ø§Ù†</small></div>
        `;
        con.appendChild(card);
    });

    // 3. Render Selects (Transaction and Transfer)
    const transSel = document.getElementById('transAcc');
    const transferFromSel = document.getElementById('transferFromAcc');
    const transferToSel = document.getElementById('transferToAcc');

    [transSel, transferFromSel, transferToSel].forEach(sel => sel.innerHTML = '');

    finance.accounts.forEach(acc => {
        transSel.add(new Option(acc.name, acc.id));
        transferFromSel.add(new Option(acc.name, acc.id));
        transferToSel.add(new Option(acc.name, acc.id));
    });
    // Set default transaction account to ID 4 (Jari)
    transSel.value = 4;

    // 4. Render History (Improved Styling)
    const hist = document.getElementById('historyList');
    hist.innerHTML = '';
    [...finance.history].reverse().forEach(h => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        let amountText = '';
        let colorClass = '';
        let typeText = '';

        if (h.type === 'income') {
            amountText = `+ ${fmt(h.amount)}`;
            colorClass = 'pos';
            typeText = 'Ø¯Ø±Ø¢Ù…Ø¯';
        } else if (h.type === 'expense') {
            amountText = `- ${fmt(h.amount)}`;
            colorClass = 'neg';
            typeText = 'Ù‡Ø²ÛŒÙ†Ù‡';
        } else if (h.type === 'transfer' || h.type === 'transfer_out') {
            // Transfer log
            amountText = `${fmt(h.amount)}`;
            colorClass = 'transfer';
            typeText = 'Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ¬Ù‡';
        }

        item.innerHTML = `
            <div>
                <span style="font-weight:700; display:block">${h.desc}</span>
                <span style="color:var(--text-muted); font-size:11px;">Ø­Ø³Ø§Ø¨: ${h.accName} Ø¯Ø± ${h.date}</span>
            </div>
            <div class="trans-detail">
                <div class="amt ${colorClass}" style="font-weight:bold; font-size:14px;">${amountText}</div>
                <span class="trans-type">${typeText}</span>
            </div>
        `;
        hist.appendChild(item);
    });
}

function resetFinanceMonth() {
    if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ Ù…ÙˆØ¬ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ø±Ø¨Ø§Ù†ÛŒØŒ ØµØ§Ø¯Ø±Ø§Øª Ùˆ Ø¨Ù„Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.')) return;
    
    const income = unFmt(document.getElementById('finIncome').value);
    const fixed = unFmt(document.getElementById('finFixed').value);
    const toAcc2 = 2500000;
    const toAcc3 = 3000000;
    
    // FIX: Account 4 (Jari) is NOT reset to 0. It retains its current balance.
    
    // 1. Calculate Acc 1 (Mehrbani) Balance
    const acc1Balance = income - fixed - toAcc2 - toAcc3;
    
    // 2. Update all accounts
    finance.accounts.find(a => a.id === 1).balance = acc1Balance;
    finance.accounts.find(a => a.id === 2).balance = toAcc2;
    finance.accounts.find(a => a.id === 3).balance = toAcc3;
    
    // 3. Log
    finance.history.push({
        date: new Date().toLocaleDateString('fa-IR'),
        desc: 'Ø´Ø±ÙˆØ¹ Ù…Ø§Ù‡ Ùˆ ØªØ³Ù‡ÛŒÙ… Ø¨ÙˆØ¯Ø¬Ù‡ (Ø¯Ø±Ø¢Ù…Ø¯ Ø§ÙˆÙ„ÛŒÙ‡)',
        amount: income,
        type: 'income',
        accName: finance.accounts.find(a => a.id === 1).name 
    });
    
    saveState();
    renderFinance();
}

function chargeWeekly() {
    if(!confirm('Ø´Ø§Ø±Ú˜ Ù‡ÙØªÚ¯ÛŒ Û² Ù…ÛŒÙ„ÛŒÙˆÙ† Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ø¬Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯ØŸ')) return;

    const acc1 = finance.accounts.find(a => a.id === 1);
    const acc4 = finance.accounts.find(a => a.id === 4);
    const amount = 2000000;
    
    if(acc1.balance < amount) return alert('Ù‡Ø´Ø¯Ø§Ø±: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ Ù…Ù‡Ø±Ø¨Ø§Ù†ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!');
    
    acc1.balance -= amount;
    acc4.balance += amount;
    
    finance.history.push({
        date: new Date().toLocaleDateString('fa-IR'),
        desc: `Ø´Ø§Ø±Ú˜ Ø®Ø±Ø¬ Ù‡ÙØªÚ¯ÛŒ Ø§Ø² ${acc1.name} Ø¨Ù‡ ${acc4.name}`,
        amount: amount,
        type: 'transfer',
        accName: `${acc1.name} -> ${acc4.name}`
    });
    
    saveState();
    renderFinance();
}

function addTransaction(type) {
    const desc = document.getElementById('transDesc').value;
    const amt = unFmt(document.getElementById('transAmount').value);
    const accId = parseInt(document.getElementById('transAcc').value);
    
    if(!desc || !amt) return alert('Ù„Ø·ÙØ§ Ù…Ø¨Ù„Øº Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    
    const acc = finance.accounts.find(a => a.id === accId);
    
    if (type === 'expense' && acc.balance < amt) alert(`Ù‡Ø´Ø¯Ø§Ø±: Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ ${acc.name} Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!`);

    if(type === 'expense') acc.balance -= amt;
    else acc.balance += amt;
    
    finance.history.push({
        date: new Date().toLocaleDateString('fa-IR'),
        desc: desc,
        amount: amt,
        type: type,
        accName: acc.name
    });
    
    document.getElementById('transDesc').value = '';
    document.getElementById('transAmount').value = '';
    
    saveState();
    renderFinance();
}

function addTransfer() {
    const fromId = parseInt(document.getElementById('transferFromAcc').value);
    const toId = parseInt(document.getElementById('transferToAcc').value);
    const amt = unFmt(document.getElementById('transferAmount').value);
    
    if (fromId === toId) return alert('Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø¯Ø£ Ùˆ Ù…Ù‚ØµØ¯ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯.');
    if (!amt || amt <= 0) return alert('Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    
    const accFrom = finance.accounts.find(a => a.id === fromId);
    const accTo = finance.accounts.find(a => a.id === toId);
    
    if (accFrom.balance < amt) return alert('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø¯Ø£ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª.');
    
    accFrom.balance -= amt;
    accTo.balance += amt;
    
    finance.history.push({
        date: new Date().toLocaleDateString('fa-IR'),
        desc: `Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ¬Ù‡ Ø§Ø² ${accFrom.name} Ø¨Ù‡ ${accTo.name}`,
        amount: amt,
        type: 'transfer',
        accName: `${accFrom.name} -> ${accTo.name}` 
    });
    
    document.getElementById('transferAmount').value = '';
    
    saveState();
    renderFinance();
}

function clearHistory() {
    if(confirm('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) {
        finance.history = [];
        saveState();
        renderFinance();
    }
}

// Initial Boot
loadState();

</script>
</body>
</html>
